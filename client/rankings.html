<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>LibreQoS ISP Rankings</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional styles specific to rankings page */
        .rankings-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .filters-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .search-container {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            font-size: 16px;
        }

        .filter-group {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            font-weight: 600;
            color: var(--text);
            min-width: 100px;
        }


        .filter-select {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            min-width: 140px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-select:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filter-select option {
            background-color: var(--background);
            color: var(--text);
            padding: 8px;
        }

        .rankings-table-container {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .rankings-table {
            width: 100%;
            border-collapse: collapse;
            color: var(--text);
        }

        .rankings-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
            z-index: 10;
            transition: background-color 0.2s ease;
        }

        .rankings-table th:hover {
            background-color: var(--accent);
        }

        .rankings-table th.sortable::after {
            content: '↕️';
            font-size: 12px;
            margin-left: 8px;
            opacity: 0.6;
        }

        .rankings-table th.sort-asc::after {
            content: '↑';
            opacity: 1;
        }

        .rankings-table th.sort-desc::after {
            content: '↓';
            opacity: 1;
        }

        .rankings-table td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: middle;
            transition: background-color 0.2s ease;
        }

        .rankings-table tbody tr {
            transition: all 0.2s ease;
        }

        .rankings-table tbody tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .rankings-table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.08);
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .rank-cell {
            font-weight: 700;
            text-align: center;
            width: 70px;
        }

        .rank-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            font-size: 14px;
        }

        .rank-1 .rank-number {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
        }

        .rank-2 .rank-number {
            background: linear-gradient(135deg, #E5E5E5, #A8A8A8);
            color: #000;
        }

        .rank-3 .rank-number {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: #fff;
        }

        .rank-regular .rank-number {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .asn-cell {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: var(--accent);
        }

        .org-cell {
            max-width: 250px;
        }

        .isp-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .org-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .asn-code {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: var(--accent);
            opacity: 0.8;
        }

        .grade-cell {
            text-align: center;
            width: 100px;
        }

        .grade-badge-table {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 14px;
            min-width: 45px;
        }

        .grade-badge-table.a-plus {
            background: linear-gradient(135deg, #00C851, #00FF00);
            color: #000;
        }

        .grade-badge-table.a {
            background: linear-gradient(135deg, #28a745, #34ce57);
            color: white;
        }

        .grade-badge-table.b {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            color: white;
        }

        .grade-badge-table.c {
            background: linear-gradient(135deg, #ffc107, #ffca2c);
            color: #000;
        }

        .grade-badge-table.d {
            background: linear-gradient(135deg, #fd7e14, #ff8c42);
            color: white;
        }

        .grade-badge-table.f {
            background: linear-gradient(135deg, #dc3545, #e55353);
            color: white;
        }

        .tests-cell {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            width: 100px;
        }

        .country-cell {
            text-align: center;
            width: 90px;
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.8;
            margin-top: 8px;
        }

        .metric-cell {
            text-align: center;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            width: 110px;
            position: relative;
        }

        .metric-value {
            font-weight: 600;
            position: relative;
            z-index: 2;
        }

        .metric-good {
            color: #00C851;
        }

        .metric-fair {
            color: #FFD700;
        }

        .metric-poor {
            color: #FF6B6B;
        }

        .confidence-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .confidence-high { background-color: var(--success); }
        .confidence-medium { background-color: var(--warning); }
        .confidence-low { background-color: var(--error); }

        .loading-container {
            text-align: center;
            padding: 40px;
            color: var(--text);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-container {
            background-color: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--error);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: var(--error);
        }

        .stats-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .stats-group {
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-icon {
            font-size: 20px;
            opacity: 0.9;
        }

        .stat-content {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            line-height: 1;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text);
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .rankings-container {
                padding: 10px;
            }

            .filter-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .filter-label {
                min-width: auto;
            }



            .rankings-table th,
            .rankings-table td {
                padding: 8px 6px;
            }

            .org-cell {
                max-width: 120px;
            }
            
            .metric-cell {
                font-size: 11px;
                width: 70px;
            }
            
            .rankings-table {
                font-size: 12px;
            }

            .stats-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="logo.svg" alt="LibreQoS Logo" class="logo">
                <h1>LibreQoS ISP Rankings</h1>
                <p class="subtitle">Single User Mode: Latency & Bufferbloat Performance Rankings</p>
                <div id="sponsorInfo" class="sponsor-info" style="display: none;"></div>
            </div>
        </header>

        <div class="rankings-container">
            <div class="filters-container">
                <div class="search-container">
                    <span class="search-icon">🔍</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search ISP name or ASN...">
                </div>
                <select class="filter-select" id="countryFilter">
                    <option value="">All Countries</option>
                    <!-- Countries will be populated dynamically based on rankings data -->
                </select>
                <select class="filter-select" id="gradeFilter">
                    <option value="">All Grades</option>
                    <option value="A">A+ / A Only</option>
                    <option value="B">B or Better</option>
                    <option value="C">C or Better</option>
                </select>
            </div>

            <div class="stats-container" id="statsContainer">
                <div class="stats-group">
                    <div class="stat-item">
                        <span class="stat-icon">🏢</span>
                        <div class="stat-content">
                            <span class="stat-value" id="totalASNs">-</span>
                            <span class="stat-label">ISPs Ranked</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">📊</span>
                        <div class="stat-content">
                            <span class="stat-value" id="totalTests">-</span>
                            <span class="stat-label">Total Tests</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">⭐</span>
                        <div class="stat-content">
                            <span class="stat-value" id="avgGrade">-</span>
                            <span class="stat-label">Average Grade</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">🕐</span>
                        <div class="stat-content">
                            <span class="stat-value" id="lastUpdate">-</span>
                            <span class="stat-label">Last Updated</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="loadingContainer" class="loading-container">
                <div class="loading-spinner"></div>
                <p>Loading ISP rankings...</p>
            </div>

            <div id="errorContainer" class="error-container" style="display: none;">
                <h3>Error Loading Rankings</h3>
                <p id="errorMessage">Unable to load rankings data. Please try again later.</p>
                <button class="btn primary" onclick="loadRankings()" style="margin-top: 15px;">Retry</button>
            </div>

            <div id="rankingsContainer" class="rankings-table-container" style="display: none;">
                <table class="rankings-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="rank">Rank</th>
                            <th class="sortable" data-sort="asn">ASN</th>
                            <th class="sortable" data-sort="name">Organization</th>
                            <th class="sortable" data-sort="grade">ASN Grade</th>
                            <th class="sortable" data-sort="tests">Tests</th>
                            <th class="sortable" data-sort="baseline_latency">Baseline (ms)</th>
                            <th class="sortable" data-sort="download_increase">Download Increase</th>
                            <th class="sortable" data-sort="upload_increase">Upload Increase (ms)</th>
                            <th class="sortable" data-sort="bidirectional_increase">Bidi Increase (ms)</th>
                            <th class="sortable" data-sort="country">Country</th>
                        </tr>
                    </thead>
                    <tbody id="rankingsTableBody">
                        <!-- Rankings data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentCountry = '';
        let currentSort = 'rank';
        let currentOrder = 'asc';
        let rankingsData = [];
        let currentSearch = '';
        let currentGradeFilter = '';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSponsorInfo();
            setupEventListeners();
            loadRankings();
        });

        function setupEventListeners() {
            // Search input
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentSearch = this.value.toLowerCase();
                    filterAndDisplayRankings();
                }, 300);
            });

            // Country filter
            document.getElementById('countryFilter').addEventListener('change', function() {
                currentCountry = this.value;
                loadRankings();
            });

            // Grade filter
            document.getElementById('gradeFilter').addEventListener('change', function() {
                currentGradeFilter = this.value;
                filterAndDisplayRankings();
            });

            // Table sorting
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const sortField = this.dataset.sort;
                    if (currentSort === sortField) {
                        currentOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort = sortField;
                        currentOrder = sortField === 'rank' ? 'asc' : 'desc';
                    }
                    updateSortHeaders();
                    filterAndDisplayRankings();
                });
            });
        }


        function updateSortHeaders() {
            document.querySelectorAll('.sortable').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (header.dataset.sort === currentSort) {
                    header.classList.add(currentOrder === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        async function loadSponsorInfo() {
            try {
                const response = await fetch('/api/sponsor');
                const data = await response.json();
                
                if (data.sponsor_name && data.sponsor_url) {
                    const sponsorInfo = document.getElementById('sponsorInfo');
                    sponsorInfo.innerHTML = `Sponsored by <a href="${data.sponsor_url}" target="_blank">${data.sponsor_name}</a>${data.sponsor_city ? ` | ${data.sponsor_city}` : ''}`;
                    sponsorInfo.style.display = 'block';
                }
            } catch (error) {
                console.log('No sponsor information available');
            }
        }

        async function loadRankings() {
            showLoading();
            hideError();

            try {
                const params = new URLSearchParams({
                    sort: 'overall_grade',
                    order: 'desc',
                    limit: 100,
                    min_tests: 5
                });

                if (currentCountry) {
                    params.append('country', currentCountry);
                }

                const response = await fetch(`/api/rankings?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                rankingsData = data.rankings || [];
                
                updateStats(data);
                populateCountryDropdown();
                filterAndDisplayRankings();
                showRankings();
                
            } catch (error) {
                console.error('Error loading rankings:', error);
                showError(error.message);
            }
        }

        function populateCountryDropdown() {
            const dropdown = document.getElementById('countryFilter');
            const currentValue = dropdown.value;
            
            // Extract unique countries from rankings data
            const countries = new Map();
            rankingsData.forEach(isp => {
                if (isp.country && isp.country !== 'Unknown' && isp.country !== 'N/A') {
                    const countryCode = isp.country;
                    const countryNames = {
                        'PH': 'Philippines', 'US': 'United States', 'IN': 'India', 'RU': 'Russia', 'CA': 'Canada', 'GB': 'United Kingdom',
                        'SG': 'Singapore', 'AU': 'Australia', 'CM': 'Cameroon', 'DE': 'Germany', 'ES': 'Spain', 'ID': 'Indonesia',
                        'MX': 'Mexico', 'BR': 'Brazil', 'CN': 'China', 'FI': 'Finland', 'FR': 'France', 'GH': 'Ghana', 'HN': 'Honduras',
                        'KZ': 'Kazakhstan', 'AF': 'Afghanistan', 'AL': 'Albania', 'DZ': 'Algeria', 'AD': 'Andorra', 'AO': 'Angola',
                        'AI': 'Anguilla', 'AG': 'Antigua and Barbuda', 'AR': 'Argentina', 'AM': 'Armenia', 'AW': 'Aruba', 'AT': 'Austria',
                        'AZ': 'Azerbaijan', 'BS': 'Bahamas', 'BH': 'Bahrain', 'BD': 'Bangladesh', 'BB': 'Barbados', 'BY': 'Belarus',
                        'BE': 'Belgium', 'BZ': 'Belize', 'BJ': 'Benin', 'BM': 'Bermuda', 'BT': 'Bhutan', 'BO': 'Bolivia', 'BA': 'Bosnia and Herzegovina',
                        'BW': 'Botswana', 'BN': 'Brunei', 'BG': 'Bulgaria', 'BF': 'Burkina Faso', 'BI': 'Burundi', 'CV': 'Cape Verde',
                        'KH': 'Cambodia', 'KY': 'Cayman Islands', 'CF': 'Central African Republic', 'TD': 'Chad', 'CL': 'Chile', 'CO': 'Colombia',
                        'KM': 'Comoros', 'CG': 'Congo', 'CD': 'Congo (DRC)', 'CR': 'Costa Rica', 'CI': 'Côte d\'Ivoire', 'HR': 'Croatia',
                        'CU': 'Cuba', 'CY': 'Cyprus', 'CZ': 'Czech Republic', 'DK': 'Denmark', 'DJ': 'Djibouti', 'DM': 'Dominica',
                        'DO': 'Dominican Republic', 'EC': 'Ecuador', 'EG': 'Egypt', 'SV': 'El Salvador', 'GQ': 'Equatorial Guinea',
                        'ER': 'Eritrea', 'EE': 'Estonia', 'SZ': 'Eswatini', 'ET': 'Ethiopia', 'FJ': 'Fiji', 'GA': 'Gabon', 'GM': 'Gambia',
                        'GE': 'Georgia', 'GR': 'Greece', 'GD': 'Grenada', 'GT': 'Guatemala', 'GN': 'Guinea', 'GW': 'Guinea-Bissau',
                        'GY': 'Guyana', 'HT': 'Haiti', 'HU': 'Hungary', 'IS': 'Iceland', 'IR': 'Iran', 'IQ': 'Iraq', 'IE': 'Ireland',
                        'IL': 'Israel', 'IT': 'Italy', 'JM': 'Jamaica', 'JP': 'Japan', 'JO': 'Jordan', 'KE': 'Kenya', 'KI': 'Kiribati',
                        'KP': 'North Korea', 'KR': 'South Korea', 'KW': 'Kuwait', 'KG': 'Kyrgyzstan', 'LA': 'Laos', 'LV': 'Latvia',
                        'LB': 'Lebanon', 'LS': 'Lesotho', 'LR': 'Liberia', 'LY': 'Libya', 'LI': 'Liechtenstein', 'LT': 'Lithuania',
                        'LU': 'Luxembourg', 'MG': 'Madagascar', 'MW': 'Malawi', 'MY': 'Malaysia', 'MV': 'Maldives', 'ML': 'Mali',
                        'MT': 'Malta', 'MH': 'Marshall Islands', 'MR': 'Mauritania', 'MU': 'Mauritius', 'FM': 'Micronesia', 'MD': 'Moldova',
                        'MC': 'Monaco', 'MN': 'Mongolia', 'ME': 'Montenegro', 'MA': 'Morocco', 'MZ': 'Mozambique', 'MM': 'Myanmar',
                        'NA': 'Namibia', 'NR': 'Nauru', 'NP': 'Nepal', 'NL': 'Netherlands', 'NZ': 'New Zealand', 'NI': 'Nicaragua',
                        'NE': 'Niger', 'NG': 'Nigeria', 'NO': 'Norway', 'OM': 'Oman', 'PK': 'Pakistan', 'PW': 'Palau', 'PA': 'Panama',
                        'PG': 'Papua New Guinea', 'PY': 'Paraguay', 'PE': 'Peru', 'PL': 'Poland', 'PT': 'Portugal', 'QA': 'Qatar',
                        'RO': 'Romania', 'RW': 'Rwanda', 'KN': 'Saint Kitts and Nevis', 'LC': 'Saint Lucia', 'VC': 'Saint Vincent and the Grenadines',
                        'WS': 'Samoa', 'SM': 'San Marino', 'ST': 'São Tomé and Príncipe', 'SA': 'Saudi Arabia', 'SN': 'Senegal',
                        'RS': 'Serbia', 'SC': 'Seychelles', 'SL': 'Sierra Leone', 'SK': 'Slovakia', 'SI': 'Slovenia', 'SB': 'Solomon Islands',
                        'SO': 'Somalia', 'ZA': 'South Africa', 'SS': 'South Sudan', 'LK': 'Sri Lanka', 'SD': 'Sudan', 'SR': 'Suriname',
                        'SE': 'Sweden', 'CH': 'Switzerland', 'SY': 'Syria', 'TW': 'Taiwan', 'TJ': 'Tajikistan', 'TZ': 'Tanzania',
                        'TH': 'Thailand', 'TL': 'Timor-Leste', 'TG': 'Togo', 'TO': 'Tonga', 'TT': 'Trinidad and Tobago', 'TN': 'Tunisia',
                        'TR': 'Turkey', 'TM': 'Turkmenistan', 'TV': 'Tuvalu', 'UG': 'Uganda', 'UA': 'Ukraine', 'AE': 'United Arab Emirates',
                        'UY': 'Uruguay', 'UZ': 'Uzbekistan', 'VU': 'Vanuatu', 'VE': 'Venezuela', 'VN': 'Vietnam', 'YE': 'Yemen',
                        'ZM': 'Zambia', 'ZW': 'Zimbabwe'
                    };
                    
                    const countryName = countryNames[countryCode] || countryCode;
                    if (!countries.has(countryCode)) {
                        countries.set(countryCode, { code: countryCode, name: countryName, count: 0 });
                    }
                    countries.get(countryCode).count++;
                }
            });
            
            // Clear existing options except "All Countries"
            dropdown.innerHTML = '<option value="">All Countries</option>';
            
            // Sort countries by ISP count (descending) then by name
            const sortedCountries = Array.from(countries.values()).sort((a, b) => {
                if (b.count !== a.count) return b.count - a.count;
                return a.name.localeCompare(b.name);
            });
            
            // Add country options
            sortedCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = `${country.name} (${country.count})`;
                dropdown.appendChild(option);
            });
            
            // Restore previous selection
            dropdown.value = currentValue;
        }

        function updateStats(data) {
            document.getElementById('totalASNs').textContent = data.total_asns || rankingsData.length;
            document.getElementById('totalTests').textContent = calculateTotalTests();
            document.getElementById('avgGrade').textContent = calculateAverageGrade();
            document.getElementById('lastUpdate').textContent = formatLastUpdate(data.generated_at);
        }

        function calculateTotalTests() {
            return rankingsData.reduce((total, isp) => total + (isp.tests || 0), 0).toLocaleString();
        }

        function calculateAverageGrade() {
            if (rankingsData.length === 0) return '-';
            const gradeValues = {'A+': 5.5, 'A': 5.0, 'B': 4.0, 'C': 3.0, 'D': 2.0, 'F': 1.0};
            const avgGrade = rankingsData.reduce((sum, isp) => {
                return sum + (gradeValues[isp.asn_grade] || 0);
            }, 0) / rankingsData.length;
            return avgGrade.toFixed(1);
        }

        function formatLastUpdate(timestamp) {
            if (!timestamp) return '-';
            // Handle ISO string format (e.g., "2025-01-13T12:34:56.789Z")
            if (typeof timestamp === 'string') {
                return new Date(timestamp).toLocaleString();
            }
            // Handle Unix timestamp (seconds since epoch)
            return new Date(timestamp * 1000).toLocaleString();
        }

        function filterAndDisplayRankings() {
            let filteredData = [...rankingsData];

            // Apply search filter
            if (currentSearch) {
                filteredData = filteredData.filter(isp => {
                    const searchTerm = currentSearch.toLowerCase();
                    return (isp.organization && isp.organization.toLowerCase().includes(searchTerm)) ||
                           (isp.asn && isp.asn.toLowerCase().includes(searchTerm));
                });
            }

            // Apply grade filter
            if (currentGradeFilter) {
                const gradeMap = {'A+': 6, 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'F': 1};
                filteredData = filteredData.filter(isp => {
                    const ispGradeValue = gradeMap[isp.asn_grade] || 0;
                    if (currentGradeFilter === 'A') {
                        return ispGradeValue >= 5; // A or A+
                    } else if (currentGradeFilter === 'B') {
                        return ispGradeValue >= 4; // B or better
                    } else if (currentGradeFilter === 'C') {
                        return ispGradeValue >= 3; // C or better
                    }
                    return true;
                });
            }

            sortAndDisplayRankings(filteredData);
        }

        function sortAndDisplayRankings(dataToSort = null) {
            const data = dataToSort || rankingsData;
            const sortedData = [...data].sort((a, b) => {
                let aVal, bVal;

                switch (currentSort) {
                    case 'rank':
                        aVal = a.rank || 0;
                        bVal = b.rank || 0;
                        break;
                    case 'asn':
                        aVal = a.asn || '';
                        bVal = b.asn || '';
                        break;
                    case 'name':
                        aVal = (a.asn_name || '').toLowerCase();
                        bVal = (b.asn_name || '').toLowerCase();
                        break;
                    case 'grade':
                        // For ASN grade, use grade order (A+ > A > B > C > D > F)
                        const gradeOrder = {'A+': 6, 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'F': 1};
                        aVal = gradeOrder[a.asn_grade] || 0;
                        bVal = gradeOrder[b.asn_grade] || 0;
                        break;
                    case 'tests':
                        aVal = a.tests || 0;
                        bVal = b.tests || 0;
                        break;
                    case 'latency':
                        aVal = a.avg_baseline_ms || 0;
                        bVal = b.avg_baseline_ms || 0;
                        break;
                    case 'download_increase':
                        aVal = a.avg_download_increase_ms || 0;
                        bVal = b.avg_download_increase_ms || 0;
                        break;
                    case 'upload_increase':
                        aVal = a.avg_upload_increase_ms || 0;
                        bVal = b.avg_upload_increase_ms || 0;
                        break;
                    case 'bidirectional_increase':
                        aVal = a.avg_bidirectional_increase_ms || 0;
                        bVal = b.avg_bidirectional_increase_ms || 0;
                        break;
                    case 'country':
                        aVal = a.country || '';
                        bVal = b.country || '';
                        break;
                    default:
                        return 0;
                }

                if (typeof aVal === 'string') {
                    return currentOrder === 'asc' 
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                } else {
                    return currentOrder === 'asc' ? aVal - bVal : bVal - aVal;
                }
            });

            displayRankings(sortedData);
        }

        function displayRankings(data) {
            const tbody = document.getElementById('rankingsTableBody');
            tbody.innerHTML = '';

            data.forEach((isp, index) => {
                const row = document.createElement('tr');
                
                const grade = isp.asn_grade || 'N/A';
                const gradeClass = `grade-${grade.toLowerCase().replace('+', '-plus')}`;
                
                let rankDisplay = isp.rank || (index + 1);
                let rankClass = '';
                if (rankDisplay === 1) rankClass = 'rank-1';
                else if (rankDisplay === 2) rankClass = 'rank-2';
                else if (rankDisplay === 3) rankClass = 'rank-3';
                else rankClass = 'rank-regular';

                // Format metrics with color coding
                function formatMetric(value, type = 'latency') {
                    if (value === null || value === undefined || value === 'N/A' || value === '') return 'N/A';
                    const numValue = parseFloat(value);
                    if (isNaN(numValue)) return 'N/A';
                    let colorClass = '';
                    
                    if (type === 'baseline') {
                        colorClass = numValue < 100 ? 'metric-good' : numValue < 150 ? 'metric-fair' : 'metric-poor';
                    } else {
                        colorClass = numValue < 30 ? 'metric-good' : numValue < 100 ? 'metric-fair' : 'metric-poor';
                    }
                    
                    return `<span class="metric-value ${colorClass}">${numValue.toFixed(1)}</span>`;
                }

                // Format country with flag - comprehensive mapping
                const countryFlags = {
                    'AF': '🇦🇫', 'AL': '🇦🇱', 'DZ': '🇩🇿', 'AD': '🇦🇩', 'AO': '🇦🇴', 'AI': '🇦🇮', 'AG': '🇦🇬', 'AR': '🇦🇷', 'AM': '🇦🇲', 'AW': '🇦🇼',
                    'AU': '🇦🇺', 'AT': '🇦🇹', 'AZ': '🇦🇿', 'BS': '🇧🇸', 'BH': '🇧🇭', 'BD': '🇧🇩', 'BB': '🇧🇧', 'BY': '🇧🇾', 'BE': '🇧🇪', 'BZ': '🇧🇿',
                    'BJ': '🇧🇯', 'BM': '🇧🇲', 'BT': '🇧🇹', 'BO': '🇧🇴', 'BA': '🇧🇦', 'BW': '🇧🇼', 'BR': '🇧🇷', 'BN': '🇧🇳', 'BG': '🇧🇬', 'BF': '🇧🇫',
                    'BI': '🇧🇮', 'CV': '🇨🇻', 'KH': '🇰🇭', 'CM': '🇨🇲', 'CA': '🇨🇦', 'KY': '🇰🇾', 'CF': '🇨🇫', 'TD': '🇹🇩', 'CL': '🇨🇱', 'CN': '🇨🇳',
                    'CO': '🇨🇴', 'KM': '🇰🇲', 'CG': '🇨🇬', 'CD': '🇨🇩', 'CR': '🇨🇷', 'CI': '🇨🇮', 'HR': '🇭🇷', 'CU': '🇨🇺', 'CY': '🇨🇾', 'CZ': '🇨🇿',
                    'DK': '🇩🇰', 'DJ': '🇩🇯', 'DM': '🇩🇲', 'DO': '🇩🇴', 'EC': '🇪🇨', 'EG': '🇪🇬', 'SV': '🇸🇻', 'GQ': '🇬🇶', 'ER': '🇪🇷', 'EE': '🇪🇪',
                    'SZ': '🇸🇿', 'ET': '🇪🇹', 'FJ': '🇫🇯', 'FI': '🇫🇮', 'FR': '🇫🇷', 'GA': '🇬🇦', 'GM': '🇬🇲', 'GE': '🇬🇪', 'DE': '🇩🇪', 'GH': '🇬🇭',
                    'GR': '🇬🇷', 'GD': '🇬🇩', 'GT': '🇬🇹', 'GN': '🇬🇳', 'GW': '🇬🇼', 'GY': '🇬🇾', 'HT': '🇭🇹', 'HN': '🇭🇳', 'HU': '🇭🇺', 'IS': '🇮🇸',
                    'IN': '🇮🇳', 'ID': '🇮🇩', 'IR': '🇮🇷', 'IQ': '🇮🇶', 'IE': '🇮🇪', 'IL': '🇮🇱', 'IT': '🇮🇹', 'JM': '🇯🇲', 'JP': '🇯🇵', 'JO': '🇯🇴',
                    'KZ': '🇰🇿', 'KE': '🇰🇪', 'KI': '🇰🇮', 'KP': '🇰🇵', 'KR': '🇰🇷', 'KW': '🇰🇼', 'KG': '🇰🇬', 'LA': '🇱🇦', 'LV': '🇱🇻', 'LB': '🇱🇧',
                    'LS': '🇱🇸', 'LR': '🇱🇷', 'LY': '🇱🇾', 'LI': '🇱🇮', 'LT': '🇱🇹', 'LU': '🇱🇺', 'MG': '🇲🇬', 'MW': '🇲🇼', 'MY': '🇲🇾', 'MV': '🇲🇻',
                    'ML': '🇲🇱', 'MT': '🇲🇹', 'MH': '🇲🇭', 'MR': '🇲🇷', 'MU': '🇲🇺', 'MX': '🇲🇽', 'FM': '🇫🇲', 'MD': '🇲🇩', 'MC': '🇲🇨', 'MN': '🇲🇳',
                    'ME': '🇲🇪', 'MA': '🇲🇦', 'MZ': '🇲🇿', 'MM': '🇲🇲', 'NA': '🇳🇦', 'NR': '🇳🇷', 'NP': '🇳🇵', 'NL': '🇳🇱', 'NZ': '🇳🇿', 'NI': '🇳🇮',
                    'NE': '🇳🇪', 'NG': '🇳🇬', 'NO': '🇳🇴', 'OM': '🇴🇲', 'PK': '🇵🇰', 'PW': '🇵🇼', 'PA': '🇵🇦', 'PG': '🇵🇬', 'PY': '🇵🇾', 'PE': '🇵🇪',
                    'PH': '🇵🇭', 'PL': '🇵🇱', 'PT': '🇵🇹', 'QA': '🇶🇦', 'RO': '🇷🇴', 'RU': '🇷🇺', 'RW': '🇷🇼', 'KN': '🇰🇳', 'LC': '🇱🇨', 'VC': '🇻🇨',
                    'WS': '🇼🇸', 'SM': '🇸🇲', 'ST': '🇸🇹', 'SA': '🇸🇦', 'SN': '🇸🇳', 'RS': '🇷🇸', 'SC': '🇸🇨', 'SL': '🇸🇱', 'SG': '🇸🇬', 'SK': '🇸🇰',
                    'SI': '🇸🇮', 'SB': '🇸🇧', 'SO': '🇸🇴', 'ZA': '🇿🇦', 'SS': '🇸🇸', 'ES': '🇪🇸', 'LK': '🇱🇰', 'SD': '🇸🇩', 'SR': '🇸🇷', 'SE': '🇸🇪',
                    'CH': '🇨🇭', 'SY': '🇸🇾', 'TW': '🇹🇼', 'TJ': '🇹🇯', 'TZ': '🇹🇿', 'TH': '🇹🇭', 'TL': '🇹🇱', 'TG': '🇹🇬', 'TO': '🇹🇴', 'TT': '🇹🇹',
                    'TN': '🇹🇳', 'TR': '🇹🇷', 'TM': '🇹🇲', 'TV': '🇹🇻', 'UG': '🇺🇬', 'UA': '🇺🇦', 'AE': '🇦🇪', 'GB': '🇬🇧', 'US': '🇺🇸', 'UY': '🇺🇾',
                    'UZ': '🇺🇿', 'VU': '🇻🇺', 'VE': '🇻🇪', 'VN': '🇻🇳', 'YE': '🇾🇪', 'ZM': '🇿🇲', 'ZW': '🇿🇼'
                };
                
                // Country names mapping
                const countryNames = {
                    'PH': 'Philippines', 'US': 'United States', 'IN': 'India', 'RU': 'Russia', 'CA': 'Canada', 'GB': 'United Kingdom',
                    'SG': 'Singapore', 'AU': 'Australia', 'CM': 'Cameroon', 'DE': 'Germany', 'ES': 'Spain', 'ID': 'Indonesia',
                    'MX': 'Mexico', 'BR': 'Brazil', 'CN': 'China', 'FI': 'Finland', 'FR': 'France', 'GH': 'Ghana', 'HN': 'Honduras',
                    'KZ': 'Kazakhstan', 'AF': 'Afghanistan', 'AL': 'Albania', 'DZ': 'Algeria', 'AD': 'Andorra', 'AO': 'Angola',
                    'AI': 'Anguilla', 'AG': 'Antigua and Barbuda', 'AR': 'Argentina', 'AM': 'Armenia', 'AW': 'Aruba', 'AT': 'Austria',
                    'AZ': 'Azerbaijan', 'BS': 'Bahamas', 'BH': 'Bahrain', 'BD': 'Bangladesh', 'BB': 'Barbados', 'BY': 'Belarus',
                    'BE': 'Belgium', 'BZ': 'Belize', 'BJ': 'Benin', 'BM': 'Bermuda', 'BT': 'Bhutan', 'BO': 'Bolivia', 'BA': 'Bosnia and Herzegovina',
                    'BW': 'Botswana', 'BN': 'Brunei', 'BG': 'Bulgaria', 'BF': 'Burkina Faso', 'BI': 'Burundi', 'CV': 'Cape Verde',
                    'KH': 'Cambodia', 'KY': 'Cayman Islands', 'CF': 'Central African Republic', 'TD': 'Chad', 'CL': 'Chile', 'CO': 'Colombia',
                    'KM': 'Comoros', 'CG': 'Congo', 'CD': 'Congo (DRC)', 'CR': 'Costa Rica', 'CI': 'Côte d\'Ivoire', 'HR': 'Croatia',
                    'CU': 'Cuba', 'CY': 'Cyprus', 'CZ': 'Czech Republic', 'DK': 'Denmark', 'DJ': 'Djibouti', 'DM': 'Dominica',
                    'DO': 'Dominican Republic', 'EC': 'Ecuador', 'EG': 'Egypt', 'SV': 'El Salvador', 'GQ': 'Equatorial Guinea',
                    'ER': 'Eritrea', 'EE': 'Estonia', 'SZ': 'Eswatini', 'ET': 'Ethiopia', 'FJ': 'Fiji', 'GA': 'Gabon', 'GM': 'Gambia',
                    'GE': 'Georgia', 'GR': 'Greece', 'GD': 'Grenada', 'GT': 'Guatemala', 'GN': 'Guinea', 'GW': 'Guinea-Bissau',
                    'GY': 'Guyana', 'HT': 'Haiti', 'HU': 'Hungary', 'IS': 'Iceland', 'IR': 'Iran', 'IQ': 'Iraq', 'IE': 'Ireland',
                    'IL': 'Israel', 'IT': 'Italy', 'JM': 'Jamaica', 'JP': 'Japan', 'JO': 'Jordan', 'KE': 'Kenya', 'KI': 'Kiribati',
                    'KP': 'North Korea', 'KR': 'South Korea', 'KW': 'Kuwait', 'KG': 'Kyrgyzstan', 'LA': 'Laos', 'LV': 'Latvia',
                    'LB': 'Lebanon', 'LS': 'Lesotho', 'LR': 'Liberia', 'LY': 'Libya', 'LI': 'Liechtenstein', 'LT': 'Lithuania',
                    'LU': 'Luxembourg', 'MG': 'Madagascar', 'MW': 'Malawi', 'MY': 'Malaysia', 'MV': 'Maldives', 'ML': 'Mali',
                    'MT': 'Malta', 'MH': 'Marshall Islands', 'MR': 'Mauritania', 'MU': 'Mauritius', 'FM': 'Micronesia', 'MD': 'Moldova',
                    'MC': 'Monaco', 'MN': 'Mongolia', 'ME': 'Montenegro', 'MA': 'Morocco', 'MZ': 'Mozambique', 'MM': 'Myanmar',
                    'NA': 'Namibia', 'NR': 'Nauru', 'NP': 'Nepal', 'NL': 'Netherlands', 'NZ': 'New Zealand', 'NI': 'Nicaragua',
                    'NE': 'Niger', 'NG': 'Nigeria', 'NO': 'Norway', 'OM': 'Oman', 'PK': 'Pakistan', 'PW': 'Palau', 'PA': 'Panama',
                    'PG': 'Papua New Guinea', 'PY': 'Paraguay', 'PE': 'Peru', 'PL': 'Poland', 'PT': 'Portugal', 'QA': 'Qatar',
                    'RO': 'Romania', 'RW': 'Rwanda', 'KN': 'Saint Kitts and Nevis', 'LC': 'Saint Lucia', 'VC': 'Saint Vincent and the Grenadines',
                    'WS': 'Samoa', 'SM': 'San Marino', 'ST': 'São Tomé and Príncipe', 'SA': 'Saudi Arabia', 'SN': 'Senegal',
                    'RS': 'Serbia', 'SC': 'Seychelles', 'SL': 'Sierra Leone', 'SK': 'Slovakia', 'SI': 'Slovenia', 'SB': 'Solomon Islands',
                    'SO': 'Somalia', 'ZA': 'South Africa', 'SS': 'South Sudan', 'LK': 'Sri Lanka', 'SD': 'Sudan', 'SR': 'Suriname',
                    'SE': 'Sweden', 'CH': 'Switzerland', 'SY': 'Syria', 'TW': 'Taiwan', 'TJ': 'Tajikistan', 'TZ': 'Tanzania',
                    'TH': 'Thailand', 'TL': 'Timor-Leste', 'TG': 'Togo', 'TO': 'Tonga', 'TT': 'Trinidad and Tobago', 'TN': 'Tunisia',
                    'TR': 'Turkey', 'TM': 'Turkmenistan', 'TV': 'Tuvalu', 'UG': 'Uganda', 'UA': 'Ukraine', 'AE': 'United Arab Emirates',
                    'UY': 'Uruguay', 'UZ': 'Uzbekistan', 'VU': 'Vanuatu', 'VE': 'Venezuela', 'VN': 'Vietnam', 'YE': 'Yemen',
                    'ZM': 'Zambia', 'ZW': 'Zimbabwe'
                };
                
                const countryDisplay = countryFlags[isp.country] ? `${countryFlags[isp.country]} ${isp.country}` : isp.country || 'N/A';

                row.innerHTML = `
                    <td class="rank-cell ${rankClass}"><span class="rank-number">${rankDisplay}</span></td>
                    <td class="asn-cell">${isp.asn || 'N/A'}</td>
                    <td class="org-cell">
                        <div class="isp-info">
                            <div class="org-name" title="${isp.organization || 'Unknown'}">${isp.organization || 'Unknown Organization'}</div>
                            <div class="asn-code">${isp.asn || 'N/A'}</div>
                        </div>
                    </td>
                    <td class="grade-cell"><span class="grade-badge-table ${gradeClass}">${grade}</span></td>
                    <td class="tests-cell">${(isp.tests || 0).toLocaleString()}</td>
                    <td class="metric-cell">${formatMetric(isp.avg_baseline_ms, 'baseline')}</td>
                    <td class="metric-cell">${formatMetric(isp.avg_download_increase_ms)}</td>
                    <td class="metric-cell">${formatMetric(isp.avg_upload_increase_ms)}</td>
                    <td class="metric-cell">${formatMetric(isp.avg_bidirectional_increase_ms)}</td>
                    <td class="country-cell">${countryDisplay}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function showLoading() {
            document.getElementById('loadingContainer').style.display = 'block';
            document.getElementById('rankingsContainer').style.display = 'none';
        }

        function showRankings() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('rankingsContainer').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('rankingsContainer').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorContainer').style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorContainer').style.display = 'none';
        }
    </script>
</body>
</html>
