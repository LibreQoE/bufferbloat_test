<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>LibreQoS ISP Rankings</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional styles specific to rankings page */
        .rankings-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .filters-container {
            background-color: var(--secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .filter-group {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            font-weight: 600;
            color: var(--text);
            min-width: 100px;
        }


        .country-filter {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: var(--background);
            color: var(--text);
            font-size: 14px;
            min-width: 120px;
        }

        .country-filter option {
            background-color: var(--background);
            color: var(--text);
        }

        .rankings-table-container {
            background-color: var(--secondary);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .rankings-table {
            width: 100%;
            border-collapse: collapse;
            color: var(--text);
        }

        .rankings-table th {
            background-color: var(--primary);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .rankings-table th:hover {
            background-color: var(--accent);
        }

        .rankings-table th.sortable::after {
            content: '↕️';
            font-size: 12px;
            margin-left: 8px;
            opacity: 0.6;
        }

        .rankings-table th.sort-asc::after {
            content: '↑';
            opacity: 1;
        }

        .rankings-table th.sort-desc::after {
            content: '↓';
            opacity: 1;
        }

        .rankings-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            vertical-align: middle;
        }

        .rankings-table tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .rankings-table tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .rank-cell {
            font-weight: 600;
            color: var(--accent);
            text-align: center;
            width: 60px;
        }

        .rank-cell.top-3 {
            font-size: 16px;
        }

        .rank-cell .rank-1 { color: #ffd700; } /* Gold */
        .rank-cell .rank-2 { color: #c0c0c0; } /* Silver */
        .rank-cell .rank-3 { color: #cd7f32; } /* Bronze */

        .asn-cell {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: var(--accent);
        }

        .org-cell {
            font-weight: 500;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .grade-cell {
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            width: 80px;
        }

        .grade-a-plus { color: #00ff00; }
        .grade-a { color: #90ee90; }
        .grade-b { color: #ffff00; }
        .grade-c { color: #ffa500; }
        .grade-d { color: #ff6347; }
        .grade-f { color: #ff0000; }

        .tests-cell {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            width: 100px;
        }

        .country-cell {
            text-align: center;
            font-weight: 500;
            width: 80px;
        }

        .metric-cell {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            width: 90px;
            color: var(--accent);
        }

        .confidence-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .confidence-high { background-color: var(--success); }
        .confidence-medium { background-color: var(--warning); }
        .confidence-low { background-color: var(--error); }

        .loading-container {
            text-align: center;
            padding: 40px;
            color: var(--text);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-container {
            background-color: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--error);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: var(--error);
        }

        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            background-color: var(--secondary);
            border-radius: 6px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--accent);
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text);
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .rankings-container {
                padding: 10px;
            }

            .filter-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .filter-label {
                min-width: auto;
            }



            .rankings-table th,
            .rankings-table td {
                padding: 8px 6px;
            }

            .org-cell {
                max-width: 120px;
            }
            
            .metric-cell {
                font-size: 11px;
                width: 70px;
            }
            
            .rankings-table {
                font-size: 12px;
            }

            .stats-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="logo.svg" alt="LibreQoS Logo" class="logo">
                <h1>LibreQoS ISP Rankings</h1>
    <p>Single User Mode: Latency & Bufferbloat Performance Rankings by ISP</p>
                <div id="sponsorInfo" class="sponsor-info" style="display: none;"></div>
            </div>
        </header>

        <div class="rankings-container">
            <div class="filters-container">
                
                <div class="filter-group">
                    <span class="filter-label">Country Filter:</span>
                    <select class="country-filter" id="countryFilter">
                        <option value="">All Countries</option>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="GB">United Kingdom</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="AU">Australia</option>
                        <option value="JP">Japan</option>
                        <option value="NL">Netherlands</option>
                        <option value="SE">Sweden</option>
                        <option value="CH">Switzerland</option>
                    </select>
                </div>
            </div>

            <div class="stats-container" id="statsContainer">
                <div class="stat-box">
                    <span class="stat-value" id="totalASNs">-</span>
                    <span class="stat-label">ISPs Ranked</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="totalTests">-</span>
                    <span class="stat-label">Total Tests</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="avgGrade">-</span>
                    <span class="stat-label">Average Grade</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="lastUpdate">-</span>
                    <span class="stat-label">Last Updated</span>
                </div>
            </div>

            <div id="loadingContainer" class="loading-container">
                <div class="loading-spinner"></div>
                <p>Loading ISP rankings...</p>
            </div>

            <div id="errorContainer" class="error-container" style="display: none;">
                <h3>Error Loading Rankings</h3>
                <p id="errorMessage">Unable to load rankings data. Please try again later.</p>
                <button class="btn primary" onclick="loadRankings()" style="margin-top: 15px;">Retry</button>
            </div>

            <div id="rankingsContainer" class="rankings-table-container" style="display: none;">
                <table class="rankings-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="rank">Rank</th>
                            <th class="sortable" data-sort="asn">ASN</th>
                            <th class="sortable" data-sort="name">Organization</th>
                            <th class="sortable" data-sort="grade">ASN Grade</th>
                            <th class="sortable" data-sort="tests">Tests</th>
                            <th class="sortable" data-sort="baseline_latency">Avg Baseline (ms)</th>
                            <th class="sortable" data-sort="download_increase">Avg Download Increase (ms)</th>
                            <th class="sortable" data-sort="upload_increase">Avg Upload Increase (ms)</th>
                            <th class="sortable" data-sort="bidirectional_increase">Avg Bidirectional Increase (ms)</th>
                            <th class="sortable" data-sort="country">Country</th>
                        </tr>
                    </thead>
                    <tbody id="rankingsTableBody">
                        <!-- Rankings data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentCountry = '';
        let currentSort = 'rank';
        let currentOrder = 'asc';
        let rankingsData = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSponsorInfo();
            setupEventListeners();
            loadRankings();
        });

        function setupEventListeners() {
            // Country filter
            document.getElementById('countryFilter').addEventListener('change', function() {
                currentCountry = this.value;
                loadRankings();
            });

            // Table sorting
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const sortField = this.dataset.sort;
                    if (currentSort === sortField) {
                        currentOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort = sortField;
                        currentOrder = sortField === 'rank' ? 'asc' : 'desc';
                    }
                    updateSortHeaders();
                    sortAndDisplayRankings();
                });
            });
        }


        function updateSortHeaders() {
            document.querySelectorAll('.sortable').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (header.dataset.sort === currentSort) {
                    header.classList.add(currentOrder === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        async function loadSponsorInfo() {
            try {
                const response = await fetch('/api/sponsor');
                const data = await response.json();
                
                if (data.sponsor_name && data.sponsor_url) {
                    const sponsorInfo = document.getElementById('sponsorInfo');
                    sponsorInfo.innerHTML = `Sponsored by <a href="${data.sponsor_url}" target="_blank">${data.sponsor_name}</a>${data.sponsor_city ? ` | ${data.sponsor_city}` : ''}`;
                    sponsorInfo.style.display = 'block';
                }
            } catch (error) {
                console.log('No sponsor information available');
            }
        }

        async function loadRankings() {
            showLoading();
            hideError();

            try {
                const params = new URLSearchParams({
                    sort: 'overall_grade',
                    order: 'desc',
                    limit: 100,
                    min_tests: 10
                });

                if (currentCountry) {
                    params.append('country', currentCountry);
                }

                const response = await fetch(`/api/rankings?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                rankingsData = data.rankings || [];
                
                updateStats(data);
                sortAndDisplayRankings();
                showRankings();
                
            } catch (error) {
                console.error('Error loading rankings:', error);
                showError(error.message);
            }
        }

        function updateStats(data) {
            document.getElementById('totalASNs').textContent = data.total_asns || rankingsData.length;
            document.getElementById('totalTests').textContent = calculateTotalTests();
            document.getElementById('avgGrade').textContent = calculateAverageGrade();
            document.getElementById('lastUpdate').textContent = formatLastUpdate(data.generated_at);
        }

        function calculateTotalTests() {
            return rankingsData.reduce((total, isp) => total + (isp.tests || 0), 0).toLocaleString();
        }

        function calculateAverageGrade() {
            if (rankingsData.length === 0) return '-';
            const gradeValues = {'A+': 5.5, 'A': 5.0, 'B': 4.0, 'C': 3.0, 'D': 2.0, 'F': 1.0};
            const avgGrade = rankingsData.reduce((sum, isp) => {
                return sum + (gradeValues[isp.asn_grade] || 0);
            }, 0) / rankingsData.length;
            return avgGrade.toFixed(1);
        }

        function formatLastUpdate(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp * 1000).toLocaleString();
        }

        function sortAndDisplayRankings() {
            const sortedData = [...rankingsData].sort((a, b) => {
                let aVal, bVal;

                switch (currentSort) {
                    case 'rank':
                        aVal = a.rank || 0;
                        bVal = b.rank || 0;
                        break;
                    case 'asn':
                        aVal = a.asn || '';
                        bVal = b.asn || '';
                        break;
                    case 'name':
                        aVal = (a.asn_name || '').toLowerCase();
                        bVal = (b.asn_name || '').toLowerCase();
                        break;
                    case 'grade':
                        // For ASN grade, use grade order (A+ > A > B > C > D > F)
                        const gradeOrder = {'A+': 6, 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'F': 1};
                        aVal = gradeOrder[a.asn_grade] || 0;
                        bVal = gradeOrder[b.asn_grade] || 0;
                        break;
                    case 'tests':
                        aVal = a.tests || 0;
                        bVal = b.tests || 0;
                        break;
                    case 'latency':
                        aVal = a.avg_baseline_ms || 0;
                        bVal = b.avg_baseline_ms || 0;
                        break;
                    case 'download_increase':
                        aVal = a.avg_download_increase_ms || 0;
                        bVal = b.avg_download_increase_ms || 0;
                        break;
                    case 'upload_increase':
                        aVal = a.avg_upload_increase_ms || 0;
                        bVal = b.avg_upload_increase_ms || 0;
                        break;
                    case 'bidirectional_increase':
                        aVal = a.avg_bidirectional_increase_ms || 0;
                        bVal = b.avg_bidirectional_increase_ms || 0;
                        break;
                    case 'country':
                        aVal = a.country || '';
                        bVal = b.country || '';
                        break;
                    default:
                        return 0;
                }

                if (typeof aVal === 'string') {
                    return currentOrder === 'asc' 
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                } else {
                    return currentOrder === 'asc' ? aVal - bVal : bVal - aVal;
                }
            });

            displayRankings(sortedData);
        }

        function displayRankings(data) {
            const tbody = document.getElementById('rankingsTableBody');
            tbody.innerHTML = '';

            data.forEach((isp, index) => {
                const row = document.createElement('tr');
                
                const grade = isp.asn_grade || 'N/A';
                const gradeClass = `grade-${grade.toLowerCase().replace('+', '-plus')}`;
                
                let rankDisplay = isp.rank || (index + 1);
                let rankClass = '';
                if (rankDisplay <= 3) {
                    rankClass = 'top-3';
                    if (rankDisplay === 1) rankDisplay = '🥇 ' + rankDisplay;
                    else if (rankDisplay === 2) rankDisplay = '🥈 ' + rankDisplay;
                    else if (rankDisplay === 3) rankDisplay = '🥉 ' + rankDisplay;
                }

                row.innerHTML = `
                    <td class="rank-cell ${rankClass}">${rankDisplay}</td>
                    <td class="asn-cell">${isp.asn || 'N/A'}</td>
                    <td class="org-cell" title="${isp.organization || 'Unknown'}">${isp.organization || 'Unknown Organization'}</td>
                    <td class="grade-cell ${gradeClass}">${grade}</td>
                    <td class="tests-cell">${(isp.tests || 0).toLocaleString()}</td>
                    <td class="metric-cell">${isp.avg_baseline_ms || 'N/A'}</td>
                    <td class="metric-cell">${isp.avg_download_increase_ms || 'N/A'}</td>
                    <td class="metric-cell">${isp.avg_upload_increase_ms || 'N/A'}</td>
                    <td class="metric-cell">${isp.avg_bidirectional_increase_ms || 'N/A'}</td>
                    <td class="country-cell">${isp.country || 'N/A'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function showLoading() {
            document.getElementById('loadingContainer').style.display = 'block';
            document.getElementById('rankingsContainer').style.display = 'none';
        }

        function showRankings() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('rankingsContainer').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('rankingsContainer').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorContainer').style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorContainer').style.display = 'none';
        }
    </script>
</body>
</html>