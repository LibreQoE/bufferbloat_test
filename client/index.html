<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>LibreQoS Bufferbloat Test</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="enhancedLogger.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="logo.svg" alt="LibreQoS Logo" class="logo">
                <h1>LibreQoS Bufferbloat Test</h1>
                <p id="headerDescription">Measure your connection's latency under load</p>
                <div id="sponsorInfo" class="sponsor-info" style="display: none;"></div>
            </div>
        </header>

        <div class="mode-toggle">
            <div class="mode-option" id="singleUserMode">
                <span class="mode-icon">üë§</span>
                <span class="mode-text">Single User Test</span>
            </div>
            <div class="mode-option" id="householdMode">
                <span class="mode-icon">üè†</span>
                <span class="mode-text">Virtual Household Mode</span>
            </div>
        </div>

        <div class="test-container">
            <div class="test-controls">
                <button id="startTest" class="btn primary">Start Test</button>
                <div id="testProgress" class="stepper-container">
                    <div class="stepper">
                        <div class="step baseline">
                            <div class="step-icon"></div>
                            <div class="step-label">Baseline</div>
                            <div class="step-connector"></div>
                        </div>
                        <div class="step download_warmup">
                            <div class="step-icon"></div>
                            <div class="step-label">Download Warmup</div>
                            <div class="step-connector"></div>
                        </div>
                        <div class="step download">
                            <div class="step-icon"></div>
                            <div class="step-label">Download Saturation</div>
                            <div class="step-connector"></div>
                        </div>
                        <div class="step upload_warmup">
                            <div class="step-icon"></div>
                            <div class="step-label">Upload Warmup</div>
                            <div class="step-connector"></div>
                        </div>
                        <div class="step upload">
                            <div class="step-icon"></div>
                            <div class="step-label">Upload Saturation</div>
                            <div class="step-connector"></div>
                        </div>
                        <div class="step bidirectional">
                            <div class="step-icon"></div>
                            <div class="step-label">Bidirectional</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                </div>
                <div id="currentPhase">Ready to start</div>
            </div>

            <div class="chart-container">
                <canvas id="latencyChart"></canvas>
            </div>
            
            <div class="throughput-chart-container">
                <canvas id="throughputChart"></canvas>
            </div>

            <div id="results" class="results-container hidden">
                <h2>Test Results</h2>
                
                <!-- Total Grade Section -->
                <div class="total-grade-container">
                    <div class="total-grade-box">
                        <h2>Total Bufferbloat Grade</h2>
                        <div id="totalGrade" class="total-grade"></div>
                        <p class="total-grade-description">Combined score from all test phases</p>
                    </div>
                </div>
                
                <!-- Share Button -->
                <div class="share-container">
                    <button id="shareResultBtn" class="btn share-btn">
                        <span class="share-icon">üì§</span>
                        Share My Result
                    </button>
                </div>
                
                <!-- Individual Grades Section -->
                <div class="individual-grades-section">
                    <h3 class="section-title">Individual Phase Grades</h3>
                    <div class="grade-container">
                        <div class="grade-box">
                            <h3>Baseline</h3>
                            <div id="baselineGrade" class="grade"></div>
                        </div>
                        <div class="grade-box">
                            <h3>Download</h3>
                            <div id="downloadGrade" class="grade"></div>
                        </div>
                        <div class="grade-box">
                            <h3>Upload</h3>
                            <div id="uploadGrade" class="grade"></div>
                        </div>
                        <div class="grade-box">
                            <h3>Bidirectional</h3>
                            <div id="bidirectionalGrade" class="grade"></div>
                        </div>
                    </div>
                </div>

                <!-- What Do My Results Mean? Section -->
                <div class="results-explanation">
                    <button id="toggleExplanation" class="explanation-toggle">
                        <span class="toggle-icon">‚ùì</span>
                        What Do My Results Mean?
                        <span class="toggle-arrow">‚ñº</span>
                    </button>
                    <div id="explanationContent" class="explanation-content hidden">
                        <div class="explanation-intro">
                            <p>Your bufferbloat grade measures both your connection's baseline latency and how much extra latency (delay) it adds when under heavy load. Lower latency values = better grades.</p>
                        </div>
                        
                        <!-- How Scores Are Calculated -->
                        <div class="calculation-explanation-section">
                            <h4>How Your Scores Are Calculated</h4>
                            <p><strong>Latency Measurement:</strong> We measure your baseline latency (idle connection), then measure latency again during heavy network load to calculate both the absolute latency values and increases.</p>
                            <div class="calculation-details">
                                <p><strong>Test Phases:</strong></p>
                                <ul>
                                    <li><strong>Baseline Phase:</strong> Measures your connection's inherent latency when idle</li>
                                    <li><strong>Download Phase:</strong> Saturates your download bandwidth while measuring latency increase</li>
                                    <li><strong>Upload Phase:</strong> Saturates your upload bandwidth while measuring latency increase</li>
                                    <li><strong>Bidirectional Phase:</strong> Saturates both download and upload simultaneously</li>
                                </ul>
                                <p><strong>Grade Calculation:</strong> We use different thresholds for baseline latency and latency increases:</p>
                                
                                <div class="grade-calculation-tables">
                                    <div class="baseline-table">
                                        <h5>Baseline Latency Grading</h5>
                                        <table class="calculation-table">
                                            <thead>
                                                <tr>
                                                    <th>Baseline Latency</th>
                                                    <th>Grade</th>
                                                    <th>Description</th>
                                                </tr>
                                            </thead>
                                            <tbody id="baselineGradeTableBody">
                                                <!-- Populated dynamically from latencyGradeThresholds.json -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="increase-table">
                                        <h5>Latency Increase Grading (Bufferbloat)</h5>
                                        <table class="calculation-table">
                                            <thead>
                                                <tr>
                                                    <th>Latency Increase</th>
                                                    <th>Grade</th>
                                                    <th>Description</th>
                                                </tr>
                                            </thead>
                                            <tbody id="increaseGradeTableBody">
                                                <!-- Populated dynamically from latencyGradeThresholds.json -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total Grade Explanation -->
                        <div class="total-grade-explanation-section">
                            <h4>Total Grade Calculation</h4>
                            <p>Your <strong>Total Bufferbloat Grade</strong> is calculated as the minimum of your baseline latency grade and the average of your three bufferbloat test phases (download, upload, bidirectional). This ensures that both your connection's inherent latency and its behavior under load are properly weighted.</p>
                            <p><strong>Example:</strong> If your baseline is A+ (65ms) and your bufferbloat phases average to A (25ms increase), your total grade is A+. If your baseline is B (110ms) but bufferbloat phases average to A+ (3ms increase), your total grade is B.</p>
                        </div>
                        
                        <!-- Individual Grades Explanation -->
                        <div class="individual-grades-explanation-section">
                            <h4>What Each Phase Tests</h4>
                            <p><strong>Baseline:</strong> Your connection's inherent latency when idle (measures base network quality)</p>
                            <p><strong>Download:</strong> How much latency increases when downloading large files (simulates streaming, software updates)</p>
                            <p><strong>Upload:</strong> How much latency increases when uploading data (simulates video calls, cloud backups)</p>
                            <p><strong>Bidirectional:</strong> How much latency increases during simultaneous heavy download and upload (simulates real-world mixed usage)</p>
                        </div>
                        
                        <div class="grade-explanations">
                            <div class="grade-explanation a-plus">
                                <div class="grade-badge">A+</div>
                                <div class="grade-description">
                                    <h4>Excellent</h4>
                                    <p>Your connection has virtually no bufferbloat! Perfect for video calls, online gaming, and real-time applications. Your connection maintains low latency even under heavy load.</p>
                                </div>
                            </div>
                            <div class="grade-explanation a">
                                <div class="grade-badge">A</div>
                                <div class="grade-description">
                                    <h4>Very Good</h4>
                                    <p>Minimal bufferbloat with excellent performance. Great for video calls, streaming, and gaming. You may notice slight delays only during very heavy usage.</p>
                                </div>
                            </div>
                            <div class="grade-explanation b">
                                <div class="grade-badge">B</div>
                                <div class="grade-description">
                                    <h4>Good</h4>
                                    <p>Moderate bufferbloat that's generally acceptable. Good for most activities, though you might notice some lag during video calls or gaming when downloading large files.</p>
                                </div>
                            </div>
                            <div class="grade-explanation c">
                                <div class="grade-badge">C</div>
                                <div class="grade-description">
                                    <h4>Fair</h4>
                                    <p>Noticeable bufferbloat that affects performance. You'll likely experience lag during video calls, choppy streaming, and delayed responses in online games when your connection is busy.</p>
                                </div>
                            </div>
                            <div class="grade-explanation d">
                                <div class="grade-badge">D</div>
                                <div class="grade-description">
                                    <h4>Poor</h4>
                                    <p>Significant bufferbloat causing major performance issues. Video calls will be problematic, streaming may buffer frequently, and online gaming will be frustrating during heavy usage.</p>
                                </div>
                            </div>
                            <div class="grade-explanation f">
                                <div class="grade-badge">F</div>
                                <div class="grade-description">
                                    <h4>Very Poor</h4>
                                    <p>Severe bufferbloat making real-time applications nearly unusable. Video calls will drop frequently, streaming will buffer constantly, and online gaming will be extremely laggy when downloading or uploading.</p>
                                </div>
                            </div>
                        </div>
                        <div class="explanation-footer">
                            <p><strong>What can I do about bufferbloat?</strong> Consider upgrading your router firmware to one with better queue management (like OpenWrt with SQM), or contact your ISP about the issue.</p>
                        </div>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="stats-box">
                        <h3>Latency (ms)</h3>
                        <table id="latencyStats" class="stats-table">
                            <thead>
                                <tr>
                                    <th>Phase</th>
                                    <th>Median</th>
                                    <th>Average</th>
                                    <th>25th %</th>
                                    <th>75th %</th>
                                    <th>95th %</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div class="stats-box">
                        <h3>Throughput (Mbps)</h3>
                        <table id="throughputStats" class="stats-table">
                            <thead>
                                <tr>
                                    <th>Direction</th>
                                    <th>Median</th>
                                    <th>Average</th>
                                    <th>75th %</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="additional-stats">
                    <div class="stat-item">
                        <span class="stat-label">Download Latency Increase:</span>
                        <span id="downloadLatencyIncrease" class="stat-value">-- ms</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Upload Latency Increase:</span>
                        <span id="uploadLatencyIncrease" class="stat-value">-- ms</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Bidirectional Latency Increase:</span>
                        <span id="bidirectionalLatencyIncrease" class="stat-value">-- ms</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Virtual Household Mode Container -->
        <div id="householdContainer" class="household-container hidden">
            <div class="household-controls">
                <button id="start-household-test" class="btn primary">Start Test</button>
                <div class="test-description">
                    <p>Simulates a household with 4 users competing for bandwidth. Limitations: best for connections under 200 Mbps.</p>
                    <p><strong>Phase 1:</strong> Connection speed detection (10s) ‚Üí <strong>Phase 2:</strong> Household simulation using detected speed (30s)</p>
                </div>
                <div class="test-progress-container">
                    <div class="progress-bar-container">
                        <div id="test-progress-bar" class="progress-bar" style="width: 0%;"></div>
                    </div>
                    
                </div>
                <div id="householdStatus" class="household-status">Ready to simulate a busy household</div>
            </div>

            <!-- Virtual Users - Horizontal Scroll Layout -->
            <div class="virtual-users">
                <!-- User Cards with Horizontal Scroll -->
                <div class="users-grid">
                        <!-- Alex -->
                        <div class="user-card" id="room-alex" data-user="alex">
                            <div class="user-header">
                                <div class="user-icon">üë¶</div>
                                <div class="user-info">
                                    <h4>Alex</h4>
                                    <p>Competitive Gaming</p>
                                </div>
                            </div>
                            <div class="activity-info">
                                <div class="activity-icon">üéÆ</div>
                                <div class="activity-text">Counter-Strike 2</div>
                            </div>
                            <div class="sentiment-container alex-sentiment" id="alexSentiment">
                                <span class="sentiment-text">"Connection feels great!"</span>
                            </div>
                            <div class="user-metrics">
                                <div class="metric metric-download">
                                    <span class="metric-label">Download:</span>
                                    <span class="metric-value">-- Mbps</span>
                                    <div class="metric-progress-container">
                                        <div class="metric-progress">
                                            <div class="metric-progress-fill download" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric metric-upload">
                                    <span class="metric-label">Upload:</span>
                                    <span class="metric-value">-- Mbps</span>
                                    <div class="metric-progress-container">
                                        <div class="metric-progress">
                                            <div class="metric-progress-fill upload" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric metric-latency">
                                    <span class="metric-label">Ping:</span>
                                    <span class="metric-value">-- ms</span>
                                    <span class="health-indicator" id="alexPingHealth">üü¢</span>
                                </div>
                                <div class="metric metric-jitter">
                                    <span class="metric-label">Jitter:</span>
                                    <span class="metric-value">-- ms</span>
                                </div>
                            </div>
                            <canvas class="sparkline" id="alexSparkline" width="200" height="40"></canvas>
                        </div>

                        <!-- Sarah -->
                        <div class="user-card" id="room-sarah" data-user="sarah">
                            <div class="user-header">
                                <div class="user-icon">üë©</div>
                                <div class="user-info">
                                    <h4>Sarah</h4>
                                    <p>Video Conference</p>
                                </div>
                            </div>
                            <div class="activity-info">
                                <div class="activity-icon">üíª</div>
                                <div class="activity-text">Microsoft Teams</div>
                            </div>
                            <div class="sentiment-container sarah-sentiment" id="sarahSentiment">
                                <span class="sentiment-text">"Can everyone hear me?"</span>
                            </div>
                            <div class="user-metrics">
                                <div class="metric metric-download">
                                    <span class="metric-label">Download:</span>
                                    <span class="metric-value">-- Mbps</span>
                                    <div class="metric-progress-container">
                                        <div class="metric-progress">
                                            <div class="metric-progress-fill download" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric metric-upload">
                                    <span class="metric-label">Upload:</span>
                                    <span class="metric-value">-- Mbps</span>
                                    <div class="metric-progress-container">
                                        <div class="metric-progress">
                                            <div class="metric-progress-fill upload" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric metric-latency">
                                    <span class="metric-label">Ping:</span>
                                    <span class="metric-value">-- ms</span>
                                    <span class="health-indicator" id="sarahPingHealth">üü¢</span>
                                </div>
                                <div class="metric metric-jitter">
                                    <span class="metric-label">Jitter:</span>
                                    <span class="metric-value">-- ms</span>
                                </div>
                            </div>
                            <canvas class="sparkline" id="sarahSparkline" width="200" height="40"></canvas>
                        </div>

                        <!-- Jake -->
                        <div class="user-card" id="room-jake" data-user="jake">
                            <div class="user-header">
                                <div class="user-icon">üë®</div>
                                <div class="user-info">
                                    <h4>Jake</h4>
                                    <p>HD Netflix Streaming</p>
                                </div>
                            </div>
                            <div class="activity-info">
                                <div class="activity-icon">üì∫</div>
                                <div class="activity-text">Netflix HD</div>
                            </div>
                            <div class="sentiment-container jake-sentiment" id="jakeSentiment">
                                <span class="sentiment-text">"Enjoying the show!"</span>
                            </div>
                            <div class="user-metrics">
                                <div class="metric metric-download">
                                    <span class="metric-label">Download:</span>
                                    <span class="metric-value">-- Mbps</span>
                                    <div class="metric-progress-container">
                                        <div class="metric-progress">
                                            <div class="metric-progress-fill download" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric metric-upload">
                                    <span class="metric-label">Upload:</span>
                                    <span class="metric-value">-- Mbps</span>
                                    <div class="metric-progress-container">
                                        <div class="metric-progress">
                                            <div class="metric-progress-fill upload" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric metric-latency">
                                    <span class="metric-label">Ping:</span>
                                    <span class="metric-value">-- ms</span>
                                    <span class="health-indicator" id="jakePingHealth">üü¢</span>
                                </div>
                                <div class="metric metric-jitter">
                                    <span class="metric-label">Jitter:</span>
                                    <span class="metric-value">-- ms</span>
                                </div>
                            </div>
                            <canvas class="sparkline" id="jakeSparkline" width="200" height="40"></canvas>
                        </div>

                        <!-- Computer -->
                        <div class="user-card" id="room-computer" data-user="computer">
                            <div class="user-header">
                                <div class="user-icon">üñ•Ô∏è</div>
                                <div class="user-info">
                                    <h4>Computer</h4>
                                    <p>Background</p>
                                </div>
                            </div>
                            <div class="activity-info">
                                <div class="activity-icon">‚òÅÔ∏è</div>
                                <div class="activity-text">Game Updates</div>
                            </div>
                            <div class="sentiment-container computer-sentiment" id="computerSentiment">
                                <span class="sentiment-text">"Working in background"</span>
                            </div>
                            <div class="user-metrics">
                                <div class="metric metric-download">
                                    <span class="metric-label">Download:</span>
                                    <span class="metric-value">-- Mbps</span>
                                    <div class="metric-progress-container">
                                        <div class="metric-progress">
                                            <div class="metric-progress-fill download" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric metric-upload">
                                    <span class="metric-label">Upload:</span>
                                    <span class="metric-value">-- Mbps</span>
                                    <div class="metric-progress-container">
                                        <div class="metric-progress">
                                            <div class="metric-progress-fill upload" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric metric-latency">
                                    <span class="metric-label">Ping:</span>
                                    <span class="metric-value">-- ms</span>
                                    <span class="health-indicator" id="computerPingHealth">üü¢</span>
                                </div>
                                <div class="metric metric-jitter">
                                    <span class="metric-label">Jitter:</span>
                                    <span class="metric-value">-- ms</span>
                                </div>
                            </div>
                            <canvas class="sparkline" id="computerSparkline" width="200" height="40"></canvas>
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- Results Summary -->
            <div id="householdResults" class="household-results hidden">
                <h2>Virtual Household Results</h2>
                
                <!-- Overall Performance -->
                <div class="overall-performance">
                    <h3>Overall Performance</h3>
                    <div class="performance-grid">
                        <div class="performance-card">
                            <h4>Overall Grade</h4>
                            <div class="performance-grade" id="overall-grade">--</div>
                            <p>Combined performance score</p>
                        </div>
                        <div class="performance-card">
                            <h4>Network Fairness</h4>
                            <div class="performance-grade" id="network-fairness">--</div>
                            <p>How well bandwidth was shared</p>
                        </div>
                        <div class="performance-card">
                            <h4>Latency Stability</h4>
                            <div class="performance-grade" id="latency-stability">--</div>
                            <p>Consistency under load</p>
                        </div>
                    </div>
                </div>

                <!-- Individual User Results -->
                <div class="user-results">
                    <h3>Individual User Results</h3>
                    <div class="user-results-grid">
                        <div class="user-result-card">
                            <div class="user-result-header">
                                <span class="user-icon">üéÆ</span>
                                <h4>Alex</h4>
                            </div>
                            <div class="user-result-grade" id="gamerResultGrade">A</div>
                            <p id="gamerResultDescription">Minimal lag, consistent ping</p>
                        </div>
                        <div class="user-result-card">
                            <div class="user-result-header">
                                <span class="user-icon">üë©‚Äçüíª</span>
                                <h4>Sarah</h4>
                            </div>
                            <div class="user-result-grade" id="workerResultGrade">A+</div>
                            <p id="workerResultDescription">Call was clear, zero drops or jitter</p>
                        </div>
                        <div class="user-result-card">
                            <div class="user-result-header">
                                <span class="user-icon">üì∫</span>
                                <h4>Jake</h4>
                            </div>
                            <div class="user-result-grade" id="streamerResultGrade">B</div>
                            <p id="streamerResultDescription">Slight buffering due BE congestion</p>
                        </div>
                        <div class="user-result-card">
                            <div class="user-result-header">
                                <span class="user-icon">‚¨áÔ∏è</span>
                                <h4>Computer</h4>
                            </div>
                            <div class="user-result-grade" id="downloaderResultGrade">C</div>
                            <p id="downloaderResultDescription">High delay, low throughput (expected)</p>
                        </div>
                    </div>
                </div>

                <!-- What Do My Results Mean? Section for Virtual Household -->
                <div class="results-explanation">
                    <button id="toggleHouseholdExplanation" class="explanation-toggle">
                        <span class="toggle-icon">‚ùì</span>
                        What Do My Results Mean?
                        <span class="toggle-arrow">‚ñº</span>
                    </button>
                    <div id="householdExplanationContent" class="explanation-content hidden">
                        <div class="explanation-intro">
                            <p>Your Virtual Household test simulates multiple users with different internet usage patterns to evaluate your network's performance under realistic load.</p>
                        </div>
                        
                        <!-- Network Fairness Explanation -->
                        <div class="metric-explanation-section">
                            <h4>Network Fairness</h4>
                            <p><strong>What it measures:</strong> How evenly bandwidth is distributed among different users and applications in your household.</p>
                            <p><strong>How it's calculated:</strong> We measure the actual throughput each virtual user receives compared to their target bandwidth needs, then calculate how fairly the available bandwidth is shared using the Jain's Fairness Index formula.</p>
                            <div class="calculation-details">
                                <p><strong>Calculation method:</strong></p>
                                <ul>
                                    <li>Each user has target bandwidth requirements (Gaming: 1.5 Mbps, Video calls: 2.5 Mbps, Streaming: 25 Mbps, Downloads: varies based on detected speed)</li>
                                    <li>We measure actual throughput achieved by each user during the test</li>
                                    <li>Fairness score = (sum of throughputs)¬≤ / (n √ó sum of throughputs¬≤) where n = number of users</li>
                                    <li>Score ranges from 0% (completely unfair) to 100% (perfectly fair)</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Latency Stability Explanation -->
                        <div class="metric-explanation-section">
                            <h4>Latency Stability</h4>
                            <p><strong>What it measures:</strong> How consistent response times remain when multiple users are active simultaneously, with emphasis on latency-sensitive applications.</p>
                            <p><strong>How it's calculated:</strong> We continuously measure latency for each user throughout the test and calculate a weighted stability score that prioritizes gaming and video conferencing users.</p>
                            <div class="calculation-details">
                                <p><strong>Updated Calculation Method (Enhanced for Realistic Thresholds):</strong></p>
                                <ul>
                                    <li>Latency is measured every 100ms for each virtual user during the 30-second household simulation</li>
                                    <li><strong>User-Specific Thresholds (Updated):</strong>
                                        <ul style="margin-top: 8px;">
                                            <li><strong>Alex (Gaming):</strong> 75ms latency, 30ms jitter threshold</li>
                                            <li><strong>Sarah (Video Calls):</strong> 150ms latency, 30ms jitter threshold (increased from 100ms for realistic expectations)</li>
                                            <li><strong>Jake (Streaming):</strong> 300ms latency, 100ms jitter threshold (increased from 200ms/20ms for better tolerance)</li>
                                            <li><strong>Computer (Downloads):</strong> 5000ms latency, 100ms jitter, 5.0% loss threshold (increased from 200ms/50ms/2.0% for background tasks)</li>
                                        </ul>
                                    </li>
                                    <li><strong>Weighted Scoring (Updated):</strong> Alex: 48%, Sarah: 48%, Jake: 4%, Computer: 0% (prioritizes latency-sensitive users)</li>
                                    <li>Individual user scores use forgiving penalty system: no penalty within 1.5x threshold, generous grading scale</li>
                                    <li>Final stability score combines weighted individual performances</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Overall Grade Calculation -->
                        <div class="metric-explanation-section">
                            <h4>Overall Grade Calculation</h4>
                            <p><strong>What it measures:</strong> Your overall network performance combining fairness, stability, and individual user experiences with realistic expectations.</p>
                            <p><strong>How it's calculated:</strong> The overall grade uses updated thresholds and more forgiving scoring to reflect real-world performance expectations.</p>
                            <div class="calculation-details">
                                <p><strong>Updated Weighting Formula:</strong></p>
                                <ul>
                                    <li><strong>Network Fairness (40%):</strong> How evenly bandwidth is distributed among users</li>
                                    <li><strong>Latency Stability (30%):</strong> Weighted stability prioritizing latency-sensitive users (Alex: 45%, Sarah: 45%, Jake: 10%, Computer: 0%)</li>
                                    <li><strong>Individual User Performance (30%):</strong> Average of all four virtual users' individual grades using enhanced scoring</li>
                                </ul>
                                <p><strong>Enhanced Calculation Steps:</strong></p>
                                <ul>
                                    <li>1. Calculate Network Fairness percentage using Jain's Fairness Index</li>
                                    <li>2. Calculate Latency Stability using weighted user performance with updated thresholds</li>
                                    <li>3. Calculate individual user grades with realistic requirements and forgiving penalties:
                                        <ul style="margin-top: 8px;">
                                            <li><strong>Alex (Gaming):</strong> 75ms latency, 30ms jitter thresholds with no penalty within 1.5x threshold</li>
                                            <li><strong>Sarah (Video Calls):</strong> 150ms latency, 30ms jitter thresholds (realistic for video conferencing)</li>
                                            <li><strong>Jake (Streaming):</strong> 300ms latency, 100ms jitter thresholds (tolerant for streaming applications)</li>
                                            <li><strong>Computer (Downloads):</strong> 5000ms latency, 100ms jitter, 5.0% loss thresholds (very tolerant for background tasks)</li>
                                        </ul>
                                    </li>
                                    <li>4. Apply generous grading scale: A+ ‚â•95%, A ‚â•90%, B ‚â•80%, C ‚â•70%, D ‚â•60%, F &lt;60%</li>
                                    <li>5. Combine using weighted formula: Overall = (Fairness √ó 0.4) + (Stability √ó 0.3) + (User Average √ó 0.3)</li>
                                    <li>6. Convert final percentage to letter grade using standard scale</li>
                                </ul>
                                <p><strong>Computer Safety Check:</strong> Computer user performance is flagged if latency exceeds 5000ms (increased from 3000ms for better tolerance of background tasks).</p>
                            </div>
                        </div>
                        
                        <!-- Grade Scale -->
                        <div class="grade-explanations">
                            <h4>Grade Scale</h4>
                            <div class="grade-explanation a-plus">
                                <div class="grade-badge">A+</div>
                                <div class="grade-description">
                                    <h4>Excellent (95-100%)</h4>
                                    <p>Outstanding network performance. All users get fair bandwidth allocation and latency remains very stable under load.</p>
                                </div>
                            </div>
                            <div class="grade-explanation a">
                                <div class="grade-badge">A</div>
                                <div class="grade-description">
                                    <h4>Very Good (90-94%)</h4>
                                    <p>Great network performance with minor variations. Most users get adequate bandwidth with stable latency.</p>
                                </div>
                            </div>
                            <div class="grade-explanation b">
                                <div class="grade-badge">B</div>
                                <div class="grade-description">
                                    <h4>Good (80-89%)</h4>
                                    <p>Good network performance with some inequality in bandwidth distribution or latency variations under load.</p>
                                </div>
                            </div>
                            <div class="grade-explanation c">
                                <div class="grade-badge">C</div>
                                <div class="grade-description">
                                    <h4>Fair (70-79%)</h4>
                                    <p>Acceptable performance but some users may experience reduced bandwidth or inconsistent latency during peak usage.</p>
                                </div>
                            </div>
                            <div class="grade-explanation d">
                                <div class="grade-badge">D</div>
                                <div class="grade-description">
                                    <h4>Poor (60-69%)</h4>
                                    <p>Poor network performance with significant bandwidth inequality or latency instability affecting user experience.</p>
                                </div>
                            </div>
                            <div class="grade-explanation f">
                                <div class="grade-badge">F</div>
                                <div class="grade-description">
                                    <h4>Very Poor (Below 60%)</h4>
                                    <p>Very poor network performance. Major bandwidth inequality and latency instability make multi-user scenarios problematic.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="explanation-footer">
                            <p><strong>What can I do to improve?</strong> Consider upgrading your router firmware to one with better Quality of Service (QoS) management, or contact your ISP about implementing Smart Queue Management (SQM).</p>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="recommendations">
                    <h3>Recommendations</h3>
                    <ul class="recommendation-list" id="recommendations-list">
                        <!-- Filled by JavaScript -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Enhanced Logging Controls -->
        <div id="enhancedLoggingControls" class="enhanced-logging-controls" style="position: fixed; bottom: 20px; right: 20px; background: white; border: 2px solid #007bff; border-radius: 8px; padding: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000; max-width: 300px; display: none;">
            <h4 style="margin: 0 0 10px 0; color: #007bff;">üîç Enhanced Logger</h4>
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                <div id="logStats">Logs: 0 entries, 0 KB</div>
                <div>Captures all console messages, WebRTC events, ICE candidates</div>
            </div>
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                <button id="exportEnhancedLogs" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">üì• Export Logs</button>
                <button id="clearEnhancedLogs" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è Clear</button>
                <button id="showLogStats" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">üìà Stats</button>
            </div>
        </div>

        <footer>
            <p>LibreQoS Bufferbloat Test<br>Built with <span class="heart">‚ù§Ô∏è</span> by <a href="https://libreqos.io" target="_blank" rel="noopener noreferrer">LibreQoS</a></p>
        </footer>
        
    </div>
    
    <!-- Enhanced Logger Controls Script -->
    <script>
        // Initialize enhanced logger controls when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if enhanced logger is available
            if (window.EnhancedLogger) {
                console.log('üîç Enhanced Logger available - setting up controls');
                
                // Create global logger instance if not exists
                if (!window.globalEnhancedLogger) {
                    window.globalEnhancedLogger = new window.EnhancedLogger('MainPage');
                    window.globalEnhancedLogger.log('üîç Enhanced Logger initialized for main page');
                }
                
                const logger = window.globalEnhancedLogger;
                
                // Export logs button
                document.getElementById('exportEnhancedLogs').addEventListener('click', () => {
                    logger.log('üì• Exporting complete logs from main page');
                    logger.exportLogs();
                });
                
                // Clear logs button
                document.getElementById('clearEnhancedLogs').addEventListener('click', () => {
                    logger.clearLogs();
                    updateLogStats();
                    logger.log('üóëÔ∏è Logs cleared from main page');
                });
                
                // Show stats button
                document.getElementById('showLogStats').addEventListener('click', () => {
                    const stats = logger.getStats();
                    logger.log('üìà Log Statistics:', stats);
                    alert(`Enhanced Logger Statistics:\nEntries: ${stats.totalEntries}\nSize: ${(stats.totalSize / 1024).toFixed(1)} KB\nOldest: ${new Date(stats.oldestEntry).toLocaleString()}\nNewest: ${new Date(stats.newestEntry).toLocaleString()}`);
                });
                
                function updateLogStats() {
                    const stats = logger.getStats();
                    document.getElementById('logStats').textContent =
                        `Logs: ${stats.totalEntries} entries, ${(stats.totalSize / 1024).toFixed(1)} KB`;
                }
                
                // Update log stats every 5 seconds
                setInterval(updateLogStats, 5000);
                updateLogStats();
                
                // Set initial visibility based on debug mode
                const enhancedLoggingControls = document.getElementById('enhancedLoggingControls');
                if (enhancedLoggingControls) {
                    enhancedLoggingControls.style.display = window.debugMode ? 'block' : 'none';
                }
                
            } else {
                console.warn('‚ö†Ô∏è Enhanced Logger not available');
                // Hide the controls if enhanced logger is not available
                document.getElementById('enhancedLoggingControls').style.display = 'none';
            }
        });
    </script>
    
    <!-- Additional CSS for Virtual Household Explanation -->
    <style>
        .metric-explanation-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .metric-explanation-section h4 {
            color: #ffffff !important;
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .metric-explanation-section p {
            color: rgba(255, 255, 255, 0.9) !important;
            margin: 10px 0;
            line-height: 1.5;
        }
        
        .calculation-details {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .calculation-details p {
            color: rgba(255, 255, 255, 0.8) !important;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .calculation-details ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .calculation-details li {
            color: rgba(255, 255, 255, 0.8) !important;
            margin: 5px 0;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .calculation-explanation-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 4px solid #45b7d1;
        }
        
        .calculation-explanation-section h4 {
            color: #ffffff !important;
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .total-grade-explanation-section,
        .individual-grades-explanation-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .total-grade-explanation-section h4,
        .individual-grades-explanation-section h4 {
            color: #ffffff !important;
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Ensure consistent styling for explanation content */
        .explanation-content h4 {
            color: #ffffff !important;
            margin: 20px 0 15px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .explanation-content p {
            color: rgba(255, 255, 255, 0.9) !important;
            line-height: 1.5;
            margin: 10px 0;
        }
        
        .explanation-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .explanation-content li {
            color: rgba(255, 255, 255, 0.8) !important;
            margin: 5px 0;
            line-height: 1.4;
        }
        
        .explanation-footer {
            margin-top: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .explanation-footer p {
            color: rgba(255, 255, 255, 0.9) !important;
            margin: 0;
            font-style: italic;
        }
        
        /* Grade Calculation Table Styles */
        .grade-calculation-table {
            margin: 15px 0;
            overflow-x: auto;
        }
        
        .calculation-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .calculation-table th {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff !important;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .calculation-table td {
            padding: 10px 15px;
            color: rgba(255, 255, 255, 0.9) !important;
            font-size: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .calculation-table tr:last-child td {
            border-bottom: none;
        }
        
        .calculation-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        /* Grade badge styles for table */
        .grade-badge-small {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            min-width: 24px;
        }
        
        .grade-badge-small.a-plus {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .grade-badge-small.a {
            background: linear-gradient(135deg, #28a745, #34ce57);
            color: white;
        }
        
        .grade-badge-small.b {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            color: white;
        }
        
        .grade-badge-small.c {
            background: linear-gradient(135deg, #ffc107, #ffca2c);
            color: #212529;
        }
        
        .grade-badge-small.d {
            background: linear-gradient(135deg, #fd7e14, #ff8c42);
            color: white;
        }
        
        .grade-badge-small.f {
            background: linear-gradient(135deg, #dc3545, #e55353);
            color: white;
        }
        
        /* Grade row highlighting */
        .grade-row.a-plus {
            background: rgba(40, 167, 69, 0.1);
        }
        
        .grade-row.a {
            background: rgba(40, 167, 69, 0.08);
        }
        
        .grade-row.b {
            background: rgba(23, 162, 184, 0.08);
        }
        
        .grade-row.c {
            background: rgba(255, 193, 7, 0.08);
        }
        
        .grade-row.d {
            background: rgba(253, 126, 20, 0.08);
        }
        
        .grade-row.f {
            background: rgba(220, 53, 69, 0.08);
        }
        
        /* Grade calculation tables layout */
        .grade-calculation-tables {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .baseline-table,
        .increase-table {
            flex: 1;
            min-width: 300px;
        }
        
        .baseline-table h5,
        .increase-table h5 {
            color: #ffffff;
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .grade-calculation-tables {
                flex-direction: column;
            }
            
            .baseline-table,
            .increase-table {
                min-width: auto;
            }
        }
    </style>
    
    <!-- Virtual Household Explanation Toggle Script -->
    <script>
        // Function to initialize Virtual Household explanation toggle
        function initializeHouseholdToggle() {
            console.log('üè† Initializing Virtual Household explanation toggle...');
            
            const toggleButton = document.getElementById('toggleHouseholdExplanation');
            const explanationContent = document.getElementById('householdExplanationContent');
            
            console.log('üè† Toggle elements found:', {
                toggleButton: !!toggleButton,
                explanationContent: !!explanationContent
            });
            
            if (toggleButton && explanationContent) {
                // Check if already initialized
                if (toggleButton.hasAttribute('data-household-initialized')) {
                    console.log('üè† Toggle already initialized, skipping');
                    return;
                }
                
                // Mark as initialized
                toggleButton.setAttribute('data-household-initialized', 'true');
                
                // Remove any existing event listeners by cloning
                const newToggleButton = toggleButton.cloneNode(true);
                toggleButton.parentNode.replaceChild(newToggleButton, toggleButton);
                newToggleButton.setAttribute('data-household-initialized', 'true');
                
                newToggleButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('üè† Virtual Household explanation toggle clicked');
                    
                    const currentExplanationContent = document.getElementById('householdExplanationContent');
                    const isHidden = currentExplanationContent.classList.contains('hidden');
                    const toggleArrow = newToggleButton.querySelector('.toggle-arrow');
                    
                    console.log('üè† Current state - hidden:', isHidden);
                    
                    if (isHidden) {
                        // Show the explanation content
                        currentExplanationContent.classList.remove('hidden');
                        newToggleButton.classList.add('expanded');
                        if (toggleArrow) toggleArrow.textContent = '‚ñ≤';
                        console.log('üè† Showing Virtual Household explanation');
                    } else {
                        // Hide the explanation content
                        currentExplanationContent.classList.add('hidden');
                        newToggleButton.classList.remove('expanded');
                        if (toggleArrow) toggleArrow.textContent = '‚ñº';
                        console.log('üè† Hiding Virtual Household explanation');
                    }
                });
                
                console.log('‚úÖ Virtual Household explanation toggle initialized successfully');
                return true;
            } else {
                console.log('‚ùå Virtual Household explanation elements not found yet');
                return false;
            }
        }
        
        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeHouseholdToggle();
        });
        
        // Listen for household test completion events
        document.addEventListener('household-test-complete', function() {
            console.log('üè† Household test complete event received, initializing toggle...');
            setTimeout(initializeHouseholdToggle, 100);
        });
        
        // Listen for any results display events
        document.addEventListener('results-displayed', function(event) {
            if (event.detail && event.detail.testType === 'virtual-household') {
                console.log('üè† Virtual household results displayed, initializing toggle...');
                setTimeout(initializeHouseholdToggle, 100);
            }
        });
        
        // Mutation observer to watch for household results being added to DOM
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // Check if household results container was added
                            if (node.id === 'householdResults' ||
                                node.querySelector && node.querySelector('#householdResults')) {
                                console.log('üè† Household results container detected in DOM, initializing toggle...');
                                setTimeout(initializeHouseholdToggle, 100);
                            }
                            // Check if the toggle button was added
                            if (node.id === 'toggleHouseholdExplanation' ||
                                node.querySelector && node.querySelector('#toggleHouseholdExplanation')) {
                                console.log('üè† Household toggle button detected in DOM, initializing...');
                                setTimeout(initializeHouseholdToggle, 100);
                            }
                        }
                    });
                }
            });
        });
        
        // Start observing
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // Periodic check as fallback
        let checkInterval = setInterval(function() {
            const householdResults = document.getElementById('householdResults');
            const toggleButton = document.getElementById('toggleHouseholdExplanation');
            
            if (householdResults && !householdResults.classList.contains('hidden') &&
                toggleButton && !toggleButton.hasAttribute('data-household-initialized')) {
                console.log('üè† Periodic check found household results, initializing toggle...');
                if (initializeHouseholdToggle()) {
                    clearInterval(checkInterval);
                }
            }
        }, 1000);
        
        // Clear interval after 30 seconds to avoid infinite checking
        setTimeout(function() {
            clearInterval(checkInterval);
        }, 30000);
        
        // Global function for manual testing
        window.toggleHouseholdExplanation = function() {
            const explanationContent = document.getElementById('householdExplanationContent');
            const toggleButton = document.getElementById('toggleHouseholdExplanation');
            
            if (explanationContent && toggleButton) {
                const isHidden = explanationContent.classList.contains('hidden');
                const toggleArrow = toggleButton.querySelector('.toggle-arrow');
                
                if (isHidden) {
                    explanationContent.classList.remove('hidden');
                    toggleButton.classList.add('expanded');
                    if (toggleArrow) toggleArrow.textContent = '‚ñ≤';
                } else {
                    explanationContent.classList.add('hidden');
                    toggleButton.classList.remove('expanded');
                    if (toggleArrow) toggleArrow.textContent = '‚ñº';
                }
                
                console.log('üè† Manual toggle executed, now hidden:', explanationContent.classList.contains('hidden'));
            } else {
                console.error('‚ùå Elements not found for manual toggle');
            }
        };
        
        // Global function to force initialization
        window.initializeHouseholdToggle = initializeHouseholdToggle;
    </script>
    
    <!-- Load anti-chunking manager and controllers -->
    <script src="virtualHousehold/antiChunkingManager.js"></script>
    <script src="virtualHousehold/householdWarmup.js"></script>
    <script src="virtualHousehold/adaptiveController.js"></script>
    
    <!-- Token manager removed -->
    
    <!-- Load modules -->
    <script type="module" src="app.js"></script>
</body>
</html>
